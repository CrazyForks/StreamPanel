!function(){"use strict";const e={connections:{},selectedConnectionId:null,selectedMessageId:null,pinnedMessageIds:{},filter:"",requestTypeFilter:"all",messageFilters:[],pendingFilters:[],searchQuery:"",autoScrollToBottom:!0};function t(t){e.searchQuery=t}function n(t,n){return e.pinnedMessageIds[t]?.has(n)||!1}function s(...e){window.__STREAM_PANEL_DEBUG__&&console.log("[Stream Panel DevTools]",...e)}function o(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function a(e){return new Date(e).toISOString()}function i(e){try{const t=new URL(e);return t.pathname+t.search}catch(t){return e}}function r(e){if(!e)return"unknown";const t=e.toLowerCase();return t.includes("xmlhttprequest")?"xhr":t.includes("fetch")?"fetch":t.includes("eventsource")?"eventsource":"unknown"}function l(e,t,n){const s=new Blob([("text/csv"===n?"\ufeff":"")+e],{type:n+";charset=utf-8"}),o=URL.createObjectURL(s),a=document.createElement("a");a.href=o,a.download=t,a.style.display="none",document.body.appendChild(a),a.click(),setTimeout(()=>{document.body.removeChild(a),URL.revokeObjectURL(o)},100)}const d="savedConnections";let c=null;async function u(){return c||new Promise((e,t)=>{const n=indexedDB.open("StreamPanelDB",1);n.onerror=()=>t(n.error),n.onsuccess=()=>{c=n.result,e(c)},n.onupgradeneeded=e=>{try{const t=e.target.result;if(!t.objectStoreNames.contains(d)){const e=t.createObjectStore(d,{keyPath:"id"});e.createIndex("originalId","originalId",{unique:!1}),e.createIndex("savedAt","savedAt",{unique:!1}),e.createIndex("url","url",{unique:!1})}}catch(e){console.error("[IndexedDB Upgrade] Error during database upgrade:",e)}}})}async function m(){const e=await u();return new Promise((t,n)=>{const s=e.transaction([d],"readonly").objectStore(d).getAll();s.onsuccess=()=>{const e=s.result||[];e.sort((e,t)=>t.savedAt-e.savedAt),t(e)},s.onerror=()=>n(s.error)})}async function g(e){const t=await u();return new Promise((n,s)=>{const o=t.transaction([d],"readonly").objectStore(d).index("originalId").get(e);o.onsuccess=()=>{n(!!o.result)},o.onerror=()=>s(o.error)})}function p(e){if(!e.createdAt)return"æœªå‘½åè¿æ¥";const t=new Date(e.createdAt);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`}let v={},f={renderMessageList:null,showListView:null,renderFilterConditions:null};async function y(){const t=Object.values(e.connections),n=e.filter.toLowerCase(),s=e.requestTypeFilter;let a=n?t.filter(e=>e.url.toLowerCase().includes(n)):t;if("all"!==s&&(a=a.filter(e=>r(e.source)===s)),a.sort((e,t)=>t.createdAt-e.createdAt),0===a.length)return void(v.connectionList.innerHTML='<div class="empty-state">æš‚æ— è¿æ¥</div>');const l=await Promise.all(a.map(async t=>{const n=i(t.url),s=t.id===e.selectedConnectionId,a=await g(t.originalId||t.id),l=t.isIframe?"badge-iframe":"badge-main",d=t.isIframe?"iframe":"ä¸»é¡µé¢",c=`status-${t.status}`,u=r(t.source),m={fetch:"badge-fetch",xhr:"badge-xhr",eventsource:"badge-eventsource",unknown:"badge-unknown"}[u]||"badge-unknown",p=u.toUpperCase(),v=a?'<span class="connection-saved-indicator" title="å·²ä¿å­˜åˆ°æ•°æ®åº“">ğŸ’¾</span>':"";return`\n      <div class="connection-item ${s?"selected":""}" data-id="${t.id}">\n        <div class="connection-url" title="${o(t.url)}">${o(n)}</div>\n        <div class="connection-meta">\n          <span class="status-dot ${c}"></span>\n          <span class="connection-badge ${l}">${d}</span>\n          <span class="connection-badge ${m}">${p}</span>\n          <span class="message-count">${t.messages.length} æ¡</span>\n          ${v}\n        </div>\n      </div>\n    `}));v.connectionList.innerHTML=l.join(""),v.connectionList.querySelectorAll(".connection-item").forEach(e=>{e.addEventListener("click",()=>{b(e.dataset.id)})})}async function b(t){const n=function(t){if(e.selectedConnectionId===t)return e.selectedConnectionId=null,e.selectedMessageId=null,!1;return e.selectedConnectionId=t,e.selectedMessageId=null,e.pendingFilters=JSON.parse(JSON.stringify(e.messageFilters)),!0}(t);await y(),f.renderMessageList&&f.renderMessageList(),f.showListView&&f.showListView(),n&&e.pendingFilters.length>0&&(v.messageFilterContainer.style.display="block",v.btnToggleFilter.classList.add("expanded"),f.renderFilterConditions&&f.renderFilterConditions())}function h(t){switch(s("Handling stream event:",t.type,t),t.type){case"stream-connection":a={id:t.connectionId,url:t.url,frameUrl:t.frameUrl,isIframe:t.isIframe,source:t.source||"unknown",status:"connecting",createdAt:t.timestamp,messages:[]},e.connections[a.id]=a,s("Created connection:",t.connectionId,t.url),b(t.connectionId);break;case"stream-open":L(t.connectionId,"open"),s("Connection opened:",t.connectionId),y();break;case"stream-message":n=t.connectionId,o={id:t.messageId,eventType:t.eventType,data:t.data,lastEventId:t.lastEventId,timestamp:t.timestamp},e.connections[n]&&e.connections[n].messages.push(o),s("Added message #"+t.messageId+" to connection:",t.connectionId),y(),e.selectedConnectionId===t.connectionId&&f.renderMessageList&&f.renderMessageList();break;case"stream-error":L(t.connectionId,"error"),y();break;case"stream-close":L(t.connectionId,"closed"),y()}var n,o,a}function L(t,n){e.connections[t]&&(e.connections[t].status=n)}let E={};function C(){E.messageListView.classList.add("active"),E.detailView.classList.remove("active")}function M(){E.messageListView.classList.remove("active"),E.detailView.classList.add("active")}let I={},S={filterMessages:null,searchMessages:null},w=null,$=0,x=null;function T(e){I=e,I.messageTbody.addEventListener("click",e=>{const t=e.target.closest(".message-row");t&&k(parseInt(t.dataset.id))})}function F(){const t=e.connections[e.selectedConnectionId];if(!t||0===t.messages.length)return I.messageTbody.innerHTML="",I.messageEmpty.style.display="flex",I.messageTbody.parentElement.style.display="none",w=null,void($=0);I.messageEmpty.style.display="none",I.messageTbody.parentElement.style.display="flex";let s=t.messages;S.filterMessages&&(s=S.filterMessages(t.messages)),S.searchMessages&&(s=S.searchMessages(s,e.searchQuery)),P(s.length,t.messages.length);const o=[...s.filter(t=>n(e.selectedConnectionId,t.id)),...s.filter(t=>!n(e.selectedConnectionId,t.id))],a=e.selectedConnectionId,i=o.length,r=a!==w,l=e.messageFilters.length>0||e.searchQuery.length>0,d=r||l;x&&cancelAnimationFrame(x),x=requestAnimationFrame(()=>{if(d)!function(t){const n=document.createDocumentFragment();t.forEach(e=>{const t=B(e);n.appendChild(t)}),I.messageTbody.innerHTML="",I.messageTbody.appendChild(n),e.autoScrollToBottom&&(I.messageTbody.scrollTop=I.messageTbody.scrollHeight)}(o);else{const t=e.autoScrollToBottom&&I.messageTbody.scrollTop+I.messageTbody.clientHeight>=I.messageTbody.scrollHeight-50;!function(t,n,s){const o=t.slice(n);if(0===o.length)return;const a=document.createDocumentFragment();o.forEach(e=>{const t=B(e);a.appendChild(t)}),I.messageTbody.appendChild(a),e.autoScrollToBottom&&s&&(I.messageTbody.scrollTop=I.messageTbody.scrollHeight)}(o,$,t)}w=a,$=i})}function B(t){const s=document.createElement("div"),a=function(e){const t=new Date(e);return`${t.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}.${String(t.getMilliseconds()).padStart(3,"0")}`}(t.timestamp),i=e.searchQuery.length>0,r=n(e.selectedConnectionId,t.id);s.className=`message-row ${i?"search-highlight":""} ${r?"pinned":""}`,s.dataset.id=t.id;const l=document.createElement("div");l.className="message-cell col-id",l.textContent=`${r?"ğŸ“Œ":""}${t.id}`;const d=document.createElement("div");d.className="message-cell col-type",d.innerHTML=i?D(t.eventType,e.searchQuery):o(t.eventType);const c=document.createElement("div");c.className="message-cell col-data",c.innerHTML=i?D(t.data,e.searchQuery):o(t.data);const u=document.createElement("div");return u.className="message-cell col-time",u.textContent=a,s.appendChild(l),s.appendChild(d),s.appendChild(c),s.appendChild(u),s}function k(t){const n=e.connections[e.selectedConnectionId];if(!n)return;const s=n.messages.find(e=>e.id===t);if(!s)return;let a;e.selectedMessageId=t,I.detailTitle.textContent=`æ¶ˆæ¯ #${t} - ${s.eventType}`;try{const e=JSON.parse(s.data);a=JSON.stringify(e,null,2).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){let t="json-number";if(/^"/.test(e)){if(/:$/.test(e))return t="json-key",'<span class="'+t+'">'+o(e=e.slice(0,-1))+"</span>:";t="json-string"}else/true|false/.test(e)?t="json-boolean":/null/.test(e)&&(t="json-null");return'<span class="'+t+'">'+o(e)+"</span>"})}catch(e){a=o(s.data)}I.detailJson.innerHTML=a,A(),M()}function A(){const t=n(e.selectedConnectionId,e.selectedMessageId);I.btnPin.classList.toggle("active",t),I.btnPin.title=t?"å–æ¶ˆç½®é¡¶æ­¤æ¶ˆæ¯":"ç½®é¡¶æ­¤æ¶ˆæ¯"}function P(t,n){0!==e.messageFilters.length?I.filterStats.textContent=t===n?`æ˜¾ç¤ºå…¨éƒ¨ ${n} æ¡æ¶ˆæ¯`:`æ˜¾ç¤º ${t}/${n} æ¡æ¶ˆæ¯`:I.filterStats.textContent=""}function D(e,t){if(!t)return o(e);const n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");const s=new RegExp(`(${n})`,"gi");return o(e).replace(s,'<span class="search-match">$1</span>')}let j={},O={renderMessageList:null,updateFilterStats:null};function q(){const t=e.connections[e.selectedConnectionId];if(!t||!t.messages)return[];const n=new Set;return t.messages.forEach(e=>{try{N(JSON.parse(e.data),"",n)}catch(e){}}),Array.from(n).sort()}function N(e,t="",n=new Set){if(null==e)return n;if(Array.isArray(e))return e.length>0&&"object"==typeof e[0]&&N(e[0],t,n),n;if("object"==typeof e)for(const s in e)if(e.hasOwnProperty(s)){const o=t?`${t}.${s}`:s;n.add(o),"object"!=typeof e[s]||null===e[s]||Array.isArray(e[s])?Array.isArray(e[s])&&e[s].length>0&&"object"==typeof e[s][0]&&N(e[s][0],o,n):N(e[s],o,n)}return n}function H(t){return 0===e.messageFilters.length?t:t.filter(t=>{try{const n=JSON.parse(t.data);return e.messageFilters.every(e=>{const t=function(e,t){const n=t.split(".");let s=e;for(const e of n){if(null==s)return;s=s[e]}return s}(n,e.field);if(void 0===t)return!1;const s=String(t),o=String(e.value);return"equals"===e.mode?s===o:"contains"!==e.mode||s.includes(o)})}catch(e){return!1}})}function U(){e.messageFilters=JSON.parse(JSON.stringify(e.pendingFilters)),O.renderMessageList&&O.renderMessageList()}function J(t,n,s,o){e.pendingFilters[t]&&(e.pendingFilters[t].field=n,e.pendingFilters[t].mode=s,e.pendingFilters[t].value=o)}function _(){const t=q();j.filterConditions.innerHTML=e.pendingFilters.map((e,t)=>`\n      <div class="filter-row" data-index="${t}">\n        <div class="filter-field-autocomplete" data-index="${t}">\n          <input type="text" class="filter-field-input" data-index="${t}"\n                 placeholder="è¾“å…¥æˆ–é€‰æ‹©å­—æ®µ..."\n                 value="${o(e.field)}"\n                 autocomplete="off">\n          <div class="filter-field-dropdown" data-index="${t}"></div>\n        </div>\n        <select class="filter-mode-select" data-index="${t}">\n          <option value="equals" ${"equals"===e.mode?"selected":""}>å…¨ç­‰</option>\n          <option value="contains" ${"contains"===e.mode?"selected":""}>åŒ…å«</option>\n        </select>\n        <input type="text" class="filter-value-input" data-index="${t}"\n               placeholder="è¾“å…¥ç­›é€‰å€¼..." value="${o(e.value)}">\n        <button class="filter-remove-btn" data-index="${t}" title="åˆ é™¤">Ã—</button>\n      </div>\n    `).join(""),function(t){j.filterConditions.querySelectorAll(".filter-field-input").forEach(n=>{const s=parseInt(n.dataset.index),a=n.parentElement.querySelector(".filter-field-dropdown"),i=()=>{const i=n.value.toLowerCase(),r=t.filter(e=>e.toLowerCase().includes(i));r.length>0?(a.innerHTML=r.map(e=>`<div class="dropdown-item" data-value="${o(e)}">${o(e)}</div>`).join(""),a.style.display="block",a.querySelectorAll(".dropdown-item").forEach(t=>{t.addEventListener("click",()=>{n.value=t.dataset.value,a.style.display="none";const o=e.pendingFilters[s];J(s,t.dataset.value,o.mode,o.value)})})):a.style.display="none"};n.addEventListener("focus",i),n.addEventListener("input",t=>{const n=e.pendingFilters[s];J(s,t.target.value,n.mode,n.value),i()}),n.addEventListener("blur",()=>{setTimeout(()=>{a.style.display="none"},200)})}),j.filterConditions.querySelectorAll(".filter-mode-select").forEach(t=>{t.addEventListener("change",t=>{const n=parseInt(t.target.dataset.index),s=e.pendingFilters[n];J(n,s.field,t.target.value,s.value)})}),j.filterConditions.querySelectorAll(".filter-value-input").forEach(t=>{t.addEventListener("input",t=>{const n=parseInt(t.target.dataset.index),s=e.pendingFilters[n];J(n,s.field,s.mode,t.target.value)}),t.addEventListener("keypress",e=>{"Enter"===e.key&&U()})}),j.filterConditions.querySelectorAll(".filter-remove-btn").forEach(t=>{t.addEventListener("click",t=>{!function(t){e.pendingFilters.splice(t,1),e.messageFilters=JSON.parse(JSON.stringify(e.pendingFilters)),_(),O.renderMessageList&&O.renderMessageList()}(parseInt(t.target.dataset.index))})})}(t)}function R(){const e="none"===j.messageFilterContainer.style.display;j.messageFilterContainer.style.display=e?"block":"none",e?j.btnToggleFilter.classList.add("expanded"):j.btnToggleFilter.classList.remove("expanded")}const V="stream-panel-filter-presets";let z={},Q={renderMessageList:null,renderFilterConditions:null};function X(){const e=localStorage.getItem(V);return e?JSON.parse(e):[]}function G(e){localStorage.setItem(V,JSON.stringify(e))}function W(){0!==e.pendingFilters.length?(z.presetModalTitle.textContent="ä¿å­˜ç­›é€‰é¢„è®¾",z.presetModalBody.innerHTML=`\n    <div class="preset-form">\n      <div class="form-group">\n        <label class="form-label">é¢„è®¾åç§°</label>\n        <input type="text" id="preset-name-input" class="form-input" placeholder="è¾“å…¥é¢„è®¾åç§°..." autofocus>\n      </div>\n      <div class="form-group">\n        <label class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</label>\n        <input type="text" id="preset-desc-input" class="form-input" placeholder="è¾“å…¥é¢„è®¾æè¿°...">\n      </div>\n      <div class="form-group">\n        <label class="form-label">ç­›é€‰æ¡ä»¶é¢„è§ˆ</label>\n        <div style="font-size: 11px; color: var(--text-secondary); padding: 8px; background: var(--bg-secondary); border-radius: 4px;">\n          ${e.pendingFilters.map(e=>`${e.field} ${"equals"===e.mode?"=":"åŒ…å«"} "${e.value}"`).join(" AND ")}\n        </div>\n      </div>\n    </div>\n  `,z.presetModalFooter.innerHTML='\n    <button class="modal-btn" id="preset-cancel-btn">å–æ¶ˆ</button>\n    <button class="modal-btn primary" id="preset-save-btn">ä¿å­˜</button>\n  ',z.presetModal.style.display="flex",document.getElementById("preset-cancel-btn").addEventListener("click",Z),document.getElementById("preset-save-btn").addEventListener("click",()=>{const t=document.getElementById("preset-name-input").value.trim(),n=document.getElementById("preset-desc-input").value.trim();if(!t)return void alert("è¯·è¾“å…¥é¢„è®¾åç§°");const s=X();s.push({id:Date.now().toString(),name:t,description:n,filters:JSON.parse(JSON.stringify(e.pendingFilters)),createdAt:(new Date).toISOString()}),G(s),Z(),alert("é¢„è®¾ä¿å­˜æˆåŠŸ")}),document.getElementById("preset-name-input").addEventListener("keypress",e=>{"Enter"===e.key&&document.getElementById("preset-save-btn").click()})):alert("è¯·å…ˆæ·»åŠ ç­›é€‰æ¡ä»¶")}function Y(){const t=X();0!==t.length?(z.presetModalTitle.textContent="åŠ è½½ç­›é€‰é¢„è®¾",z.presetModalBody.innerHTML=`\n    <div class="preset-list">\n      ${t.map(e=>`\n        <div class="preset-item" data-preset-id="${e.id}">\n          <div class="preset-info">\n            <div class="preset-name">${o(e.name)}</div>\n            <div class="preset-description">\n              ${e.description?o(e.description):""}\n              <br>\n              <span style="font-size: 10px; color: var(--text-muted);">\n                ${e.filters.map(e=>`${e.field} ${"equals"===e.mode?"=":"åŒ…å«"} "${e.value}"`).join(", ")}\n              </span>\n            </div>\n          </div>\n          <div class="preset-actions">\n            <button class="preset-btn load-preset-btn" data-preset-id="${e.id}">åŠ è½½</button>\n            <button class="preset-btn delete-preset-btn" data-preset-id="${e.id}">åˆ é™¤</button>\n          </div>\n        </div>\n      `).join("")}\n    </div>\n  `,z.presetModalFooter.innerHTML='\n    <button class="modal-btn" id="preset-close-btn">å…³é—­</button>\n  ',z.presetModal.style.display="flex",document.getElementById("preset-close-btn").addEventListener("click",Z),document.querySelectorAll(".load-preset-btn").forEach(n=>{n.addEventListener("click",()=>{const s=n.dataset.presetId,o=t.find(e=>e.id===s);o&&(e.pendingFilters=JSON.parse(JSON.stringify(o.filters)),e.messageFilters=JSON.parse(JSON.stringify(o.filters)),z.messageFilterContainer.style.display="block",z.btnToggleFilter.classList.add("expanded"),Q.renderFilterConditions&&Q.renderFilterConditions(),Q.renderMessageList&&Q.renderMessageList(),Z())})}),document.querySelectorAll(".delete-preset-btn").forEach(e=>{e.addEventListener("click",()=>{if(confirm("ç¡®å®šè¦åˆ é™¤æ­¤é¢„è®¾å—ï¼Ÿ")){const n=e.dataset.presetId;G(t.filter(e=>e.id!==n)),Y()}})})):alert("æš‚æ— å·²ä¿å­˜çš„é¢„è®¾")}function Z(){z.presetModal.style.display="none"}let K={};function ee(){const t=function(){const t=Object.values(e.connections),n=t.length,s=t.filter(e=>"open"===e.status).length,o=t.reduce((e,t)=>e+t.messages.length,0);return{totalConnections:n,activeConnections:s,totalMessages:o,avgMessages:n>0?Math.round(o/n):0,connections:t.map(e=>({id:e.id,url:e.url,status:e.status,messageCount:e.messages.length,createdAt:e.createdAt,duration:Date.now()-e.createdAt}))}}();document.getElementById("stat-total-connections").textContent=t.totalConnections,document.getElementById("stat-active-connections").textContent=t.activeConnections,document.getElementById("stat-total-messages").textContent=t.totalMessages,document.getElementById("stat-avg-messages").textContent=t.avgMessages;const n=document.getElementById("stats-connection-list");0===t.connections.length?n.innerHTML='<div style="text-align: center; color: var(--text-muted); padding: 20px;">æš‚æ— è¿æ¥æ•°æ®</div>':n.innerHTML=t.connections.map(e=>{return`\n      <div class="stats-connection-item">\n        <div class="stats-connection-header">\n          <div class="stats-connection-url" title="${o(e.url)}">${o(i(e.url))}</div>\n          <span class="stats-connection-status status-${e.status}">${t=e.status,{connecting:"è¿æ¥ä¸­",open:"å·²è¿æ¥",closed:"å·²å…³é—­",error:"é”™è¯¯"}[t]||t}</span>\n        </div>\n        <div class="stats-connection-details">\n          <div class="stats-detail-item">\n            <span class="stats-detail-label">æ¶ˆæ¯æ•°</span>\n            <span class="stats-detail-value">${e.messageCount}</span>\n          </div>\n          <div class="stats-detail-item">\n            <span class="stats-detail-label">æŒç»­æ—¶é—´</span>\n            <span class="stats-detail-value">${function(e){const t=Math.floor(e/1e3),n=Math.floor(t/60),s=Math.floor(n/60);return s>0?`${s}h ${n%60}m`:n>0?`${n}m ${t%60}s`:`${t}s`}(e.duration)}</span>\n          </div>\n          <div class="stats-detail-item">\n            <span class="stats-detail-label">ID</span>\n            <span class="stats-detail-value">${e.id.substring(0,8)}...</span>\n          </div>\n        </div>\n      </div>\n    `;var t}).join(""),K.statsModal.style.display="flex"}function te(){K.statsModal.style.display="none"}let ne={},se=null,oe={renderConnectionList:null,renderMessageList:null,showMessageDetail:null,toggleFilterContainer:null,handleExport:null,showSavePresetModal:null,showLoadPresetModal:null,closePresetModal:null,showStatisticsModal:null,closeStatisticsModal:null};function ae(n,s){ne=n,se=s,ne.btnClear.addEventListener("click",()=>{e.connections={},e.selectedConnectionId=null,e.selectedMessageId=null,oe.renderConnectionList&&oe.renderConnectionList(),oe.renderMessageList&&oe.renderMessageList(),C(),se.postMessage({type:"clear"})}),ne.filterInput.addEventListener("input",t=>{var n;n=t.target.value,e.filter=n,oe.renderConnectionList&&oe.renderConnectionList()}),ne.requestTypeFilter.addEventListener("change",t=>{var n;n=t.target.value,e.requestTypeFilter=n,oe.renderConnectionList&&oe.renderConnectionList()}),ne.btnToggleFilter.addEventListener("click",()=>{oe.toggleFilterContainer&&oe.toggleFilterContainer()}),ne.btnScrollTop.addEventListener("click",()=>{ne.messageTbody.scrollTop=0}),ne.btnAutoScroll.addEventListener("click",()=>{const t=!e.autoScrollToBottom;var n;n=t,e.autoScrollToBottom=n,ne.btnAutoScroll.classList.toggle("active",t),t&&(ne.messageTbody.scrollTop=ne.messageTbody.scrollHeight)}),ne.btnAddFilter.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("addFilter"))}),ne.btnApplyFilters.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("applyFilters"))}),ne.btnClearFilters.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("clearFilters"))}),ne.btnExport.addEventListener("click",e=>{e.stopPropagation(),ne.exportDropdown.classList.toggle("open")}),ne.exportMenu.querySelectorAll(".export-menu-item").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.export;oe.handleExport&&oe.handleExport(n),ne.exportDropdown.classList.remove("open")})}),document.addEventListener("click",e=>{ne.exportDropdown.contains(e.target)||ne.exportDropdown.classList.remove("open")}),ne.btnSavePreset.addEventListener("click",()=>{oe.showSavePresetModal&&oe.showSavePresetModal()}),ne.btnLoadPreset.addEventListener("click",()=>{oe.showLoadPresetModal&&oe.showLoadPresetModal()}),ne.presetModalClose.addEventListener("click",()=>{oe.closePresetModal&&oe.closePresetModal()}),ne.btnStats.addEventListener("click",()=>{oe.showStatisticsModal&&oe.showStatisticsModal()}),ne.statsModalClose.addEventListener("click",()=>{oe.closeStatisticsModal&&oe.closeStatisticsModal()}),ne.btnSaveConnection.addEventListener("click",()=>{oe.showSaveConnectionModal&&oe.showSaveConnectionModal()}),ne.btnSavedConnections.addEventListener("click",()=>{oe.showSavedConnectionsModal&&oe.showSavedConnectionsModal()}),ne.savedConnectionsModalClose.addEventListener("click",()=>{oe.closeSavedConnectionsModal&&oe.closeSavedConnectionsModal()}),ne.btnCloseSavedModal.addEventListener("click",()=>{oe.closeSavedConnectionsModal&&oe.closeSavedConnectionsModal()}),ne.btnDeleteAllSaved.addEventListener("click",()=>{oe.deleteAllSavedConnections&&oe.deleteAllSavedConnections()}),ne.btnBack.addEventListener("click",()=>{C()}),ne.btnCopy.addEventListener("click",async()=>{const t=e.connections[e.selectedConnectionId];if(!t)return;const n=t.messages.find(t=>t.id===e.selectedMessageId);n&&(await async function(e){try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(e),!0}catch(e){console.warn("Clipboard API failed, falling back to execCommand:",e)}const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",t.style.top="-9999px",t.style.opacity="0",document.body.appendChild(t),t.select();try{const e=document.execCommand("copy");return document.body.removeChild(t),e}catch(e){return console.error("Failed to copy:",e),document.body.removeChild(t),!1}}(n.data)?alert("æ¶ˆæ¯æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼"):alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚"))}),ne.btnPin.addEventListener("click",()=>{!function(t,n){e.pinnedMessageIds[t]||(e.pinnedMessageIds[t]=new Set);const s=e.pinnedMessageIds[t];s.has(n)?s.delete(n):s.add(n)}(e.selectedConnectionId,e.selectedMessageId),oe.updatePinButtonState&&oe.updatePinButtonState(),oe.renderMessageList&&oe.renderMessageList()}),function(){const e=document.querySelector(".resizer"),t=document.querySelector(".left-panel");let n=!1;e.addEventListener("mousedown",()=>{n=!0,document.body.style.cursor="col-resize",document.body.style.userSelect="none"}),document.addEventListener("mousemove",e=>{if(!n)return;const s=e.clientX;s>=150&&s<=400&&(t.style.width=s+"px")}),document.addEventListener("mouseup",()=>{n=!1,document.body.style.cursor="",document.body.style.userSelect=""})}(),ne.messageSearchInput.addEventListener("input",n=>{t(n.target.value),ne.btnClearSearch.style.display=e.searchQuery?"block":"none",oe.renderMessageList&&oe.renderMessageList()}),ne.btnClearSearch.addEventListener("click",()=>{t(""),ne.messageSearchInput.value="",ne.btnClearSearch.style.display="none",oe.renderMessageList&&oe.renderMessageList()}),ne.presetModal.addEventListener("click",e=>{e.target===ne.presetModal&&oe.closePresetModal&&oe.closePresetModal()}),ne.statsModal.addEventListener("click",e=>{e.target===ne.statsModal&&oe.closeStatisticsModal&&oe.closeStatisticsModal()}),ne.savedConnectionsModal.addEventListener("click",e=>{e.target===ne.savedConnectionsModal&&oe.closeSavedConnectionsModal&&oe.closeSavedConnectionsModal()})}let ie={},re={renderConnectionList:null,renderMessageList:null,selectConnection:null};async function le(){const t=e.connections[e.selectedConnectionId];if(!t)return void alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¿æ¥");if(0===t.messages.length)return void alert("æ­¤è¿æ¥æ²¡æœ‰æ¶ˆæ¯æ•°æ®");if("archived"===t.status||t.savedId)return void alert("æ­¤è¿æ¥å·²ä»æ•°æ®åº“åŠ è½½ï¼Œæ— éœ€å†æ¬¡ä¿å­˜");const n=await g(t.id),s=pe(t.createdAt);ie.presetModalTitle.textContent="ä¿å­˜è¿æ¥",ie.presetModalBody.innerHTML=`\n    <div class="preset-form">\n      <div class="form-group">\n        <label class="form-label">è¿æ¥åç§°</label>\n        <input type="text" id="connection-name-input" class="form-input"\n               placeholder="è¾“å…¥è¿æ¥åç§°..."\n               value="${n?"ï¼ˆè¦†ç›–å·²ä¿å­˜çš„è¿æ¥ï¼‰":s}">\n      </div>\n      <div class="form-group">\n        <label class="form-label">è¿æ¥ä¿¡æ¯</label>\n        <div class="connection-info-box">\n          <div class="info-row"><strong>URL:</strong> <span class="info-url" title="${o(t.url)}">${o(t.url)}</span></div>\n          <div><strong>æ¶ˆæ¯æ•°é‡:</strong> ${t.messages.length} æ¡</div>\n          <div><strong>çŠ¶æ€:</strong> ${t.status}</div>\n          <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${s}</div>\n        </div>\n      </div>\n    </div>\n  `,ie.presetModalFooter.innerHTML='\n    <button class="modal-btn" id="connection-cancel-btn">å–æ¶ˆ</button>\n    <button class="modal-btn primary" id="connection-save-btn">ä¿å­˜</button>\n  ',ie.presetModal.style.display="flex";const a=document.getElementById("connection-name-input"),i=document.getElementById("connection-save-btn");document.getElementById("connection-cancel-btn").addEventListener("click",ge),i.addEventListener("click",async()=>{if(!a.value.trim())return void alert("è¯·è¾“å…¥è¿æ¥åç§°");const e={name:a.value.trim()};if(n){const n=await async function(e){const t=await u();return new Promise((n,s)=>{const o=t.transaction([d],"readonly").objectStore(d).index("originalId").get(e);o.onsuccess=()=>{n(o.result||null)},o.onerror=()=>s(o.error)})}(t.id);n&&(e.savedId=n.id)}try{await async function(e,t={}){const n=await u();return new Promise((s,o)=>{const a=n.transaction([d],"readwrite").objectStore(d),i={id:t.savedId||`saved-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,originalId:e.id,name:t.name||p(e),url:e.url,frameUrl:e.frameUrl||null,isIframe:e.isIframe||!1,source:e.source||"unknown",status:e.status,createdAt:e.createdAt,savedAt:Date.now(),messages:JSON.parse(JSON.stringify(e.messages)),messageCount:e.messages.length},r=a.put(i);r.onsuccess=()=>s(i),r.onerror=()=>o(r.error)})}(t,e);ge(),alert("è¿æ¥ä¿å­˜æˆåŠŸï¼"),re.renderConnectionList&&re.renderConnectionList()}catch(e){console.error("ä¿å­˜å¤±è´¥:",e),alert("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•")}}),a.addEventListener("keypress",e=>{"Enter"===e.key&&i.click()})}async function de(){const e=await m();0!==e.length?(ie.savedConnectionsModalTitle.textContent="å·²ä¿å­˜çš„è¿æ¥",ce(e),ie.savedConnectionsModal.style.display="flex"):alert("æš‚æ— å·²ä¿å­˜çš„è¿æ¥")}function ce(t){ie.savedConnectionsList.innerHTML=t.map(e=>{const t=pe(e.savedAt),n=pe(e.createdAt);return`\n      <div class="saved-connection-card" data-id="${e.id}" data-original-id="${e.originalId}">\n        <div class="saved-connection-info">\n          <div class="saved-connection-name">\n            ${o(e.name)}\n            ${e.isIframe?'<span class="connection-badge badge-iframe">iframe</span>':""}\n          </div>\n          <div class="saved-connection-url" title="${o(e.url)}">\n            ${o(e.url)}\n          </div>\n          <div class="saved-connection-meta">\n            <span>ğŸ’¬ ${e.messageCount} æ¡æ¶ˆæ¯</span>\n            <span>ğŸ“… ä¿å­˜äº ${t}</span>\n            <span>ğŸ• åˆ›å»ºäº ${n}</span>\n          </div>\n        </div>\n        <div class="saved-connection-actions">\n          <button class="saved-connection-btn load" title="åŠ è½½æ­¤è¿æ¥" data-id="${e.id}">\n            ğŸ“¤ åŠ è½½\n          </button>\n          <button class="saved-connection-btn delete" title="åˆ é™¤æ­¤è¿æ¥" data-id="${e.id}">\n            ğŸ—‘ï¸ åˆ é™¤\n          </button>\n        </div>\n      </div>\n    `}).join(""),ie.savedConnectionsList.querySelectorAll(".saved-connection-btn.load").forEach(t=>{t.addEventListener("click",n=>{n.stopPropagation(),async function(t){try{const n=await async function(e){const t=await u();return new Promise((n,s)=>{const o=t.transaction([d],"readonly").objectStore(d).get(e);o.onsuccess=()=>{o.result?n(o.result):n(null)},o.onerror=()=>s(o.error)})}(t);if(!n)return void alert("æœªæ‰¾åˆ°è¿æ¥æ•°æ®");const s={id:`archived-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,originalId:n.originalId,savedId:t,url:n.url,frameUrl:n.frameUrl,isIframe:n.isIframe,source:n.source,status:"archived",createdAt:n.createdAt,messages:n.messages};!function(t){e.connections[t.id]=t}(s),re.selectConnection&&re.selectConnection(s.id),re.renderConnectionList&&re.renderConnectionList(),re.renderMessageList&&re.renderMessageList(),me()}catch(e){console.error("åŠ è½½å¤±è´¥:",e),alert("åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•")}}(t.dataset.id)})}),ie.savedConnectionsList.querySelectorAll(".saved-connection-btn.delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),async function(e){if(!confirm("ç¡®å®šè¦åˆ é™¤æ­¤è¿æ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚"))return;try{await async function(e){const t=await u();return new Promise((n,s)=>{const o=t.transaction([d],"readwrite").objectStore(d).delete(e);o.onsuccess=()=>n(!0),o.onerror=()=>s(o.error)})}(e);const t=await m();0===t.length?me():ce(t),re.renderConnectionList&&re.renderConnectionList(),alert("è¿æ¥å·²åˆ é™¤")}catch(e){console.error("åˆ é™¤å¤±è´¥:",e),alert("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•")}}(e.dataset.id)})})}async function ue(){const e=await m();if(0!==e.length){if(confirm(`ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ ${e.length} ä¸ªå·²ä¿å­˜çš„è¿æ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`))try{await async function(){const e=await u();return new Promise((t,n)=>{const s=e.transaction([d],"readwrite").objectStore(d).clear();s.onsuccess=()=>t(!0),s.onerror=()=>n(s.error)})}(),me(),alert("æ‰€æœ‰è¿æ¥å·²åˆ é™¤"),re.renderConnectionList&&re.renderConnectionList()}catch(e){console.error("åˆ é™¤å¤±è´¥:",e),alert("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•")}}else alert("æš‚æ— å·²ä¿å­˜çš„è¿æ¥")}function me(){ie.savedConnectionsModal.style.display="none"}function ge(){ie.presetModal.style.display="none"}function pe(e){const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`}function ve(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(e=>!!e.eventType.toLowerCase().includes(n)||(!!e.data.toLowerCase().includes(n)||!(!e.lastEventId||!e.lastEventId.toLowerCase().includes(n))))}function fe(e,t){l(JSON.stringify(e,null,2),t,"application/json")}function ye(){const t=e.connections[e.selectedConnectionId];if(!t)return void alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¿æ¥");const n=H(t.messages);if(0===n.length)return void alert("å½“å‰è¿æ¥æ²¡æœ‰æ¶ˆæ¯å¯å¯¼å‡º");l(function(e,t=null){const n=["ID","EventType","Data","LastEventId","Timestamp"];t&&n.unshift("ConnectionURL","ConnectionID");const s=e.map(e=>{const n=e=>{if(null==e)return"";const t=String(e);return t.includes(",")||t.includes("\n")||t.includes('"')?'"'+t.replace(/"/g,'""')+'"':t},s=[n(e.id),n(e.eventType),n(e.data),n(e.lastEventId),n(e.timestamp)];return t&&s.unshift(n(t.url),n(t.id)),s.join(",")});return[n.join(","),...s].join("\n")}(n.map(e=>({...e,timestamp:a(e.timestamp)}))),`stream-messages-${t.id.substring(0,8)}-${Date.now()}.csv`,"text/csv")}function be(t){switch(t){case"current-json":{const t=function(){const t=e.connections[e.selectedConnectionId];if(!t)return null;const n=H(t.messages);return{connection:{id:t.id,url:t.url,frameUrl:t.frameUrl,isIframe:t.isIframe,status:t.status,createdAt:a(t.createdAt)},messages:n.map(e=>({id:e.id,eventType:e.eventType,data:e.data,lastEventId:e.lastEventId,timestamp:a(e.timestamp)})),exportedAt:(new Date).toISOString(),totalMessages:n.length,appliedFilters:e.messageFilters.length>0?e.messageFilters:null}}();if(!t)return void alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¿æ¥");const n=`stream-${t.connection.id.substring(0,8)}-${Date.now()}.json`;fe(t,n);break}case"current-csv":ye();break;case"all-json":{const t=function(){const t=Object.values(e.connections);return 0===t.length?null:{connections:t.map(e=>({id:e.id,url:e.url,frameUrl:e.frameUrl,isIframe:e.isIframe,status:e.status,createdAt:a(e.createdAt),messages:e.messages.map(e=>({id:e.id,eventType:e.eventType,data:e.data,lastEventId:e.lastEventId,timestamp:a(e.timestamp)})),messageCount:e.messages.length})),exportedAt:(new Date).toISOString(),totalConnections:t.length,totalMessages:t.reduce((e,t)=>e+t.messages.length,0)}}();if(!t)return void alert("æ²¡æœ‰è¿æ¥æ•°æ®å¯å¯¼å‡º");fe(t,`stream-all-${Date.now()}.json`);break}case"all-csv":!function(){const t=Object.values(e.connections);if(0===t.length)return void alert("æ²¡æœ‰è¿æ¥æ•°æ®å¯å¯¼å‡º");const n=[];if(t.forEach(e=>{e.messages.forEach(t=>{n.push({...t,timestamp:a(t.timestamp),connectionUrl:e.url,connectionId:e.id})})}),0===n.length)return void alert("æ²¡æœ‰æ¶ˆæ¯æ•°æ®å¯å¯¼å‡º");const s=n.map(e=>{const t=e=>{if(null==e)return"";const t=String(e);return t.includes(",")||t.includes("\n")||t.includes('"')?'"'+t.replace(/"/g,'""')+'"':t};return[t(e.connectionId),t(e.connectionUrl),t(e.id),t(e.eventType),t(e.data),t(e.lastEventId),t(e.timestamp)].join(",")});l([["ConnectionID","ConnectionURL","ID","EventType","Data","LastEventId","Timestamp"].join(","),...s].join("\n"),`stream-all-messages-${Date.now()}.csv`,"text/csv")}()}}window.__STREAM_PANEL_DEBUG__=!1;const he={connectionList:document.getElementById("connection-list"),messageTbody:document.getElementById("message-tbody"),messageEmpty:document.getElementById("message-empty"),messageListView:document.getElementById("message-list-view"),detailView:document.getElementById("detail-view"),detailTitle:document.getElementById("detail-title"),detailJson:document.getElementById("detail-json"),btnClear:document.getElementById("btn-clear"),btnBack:document.getElementById("btn-back"),btnCopy:document.getElementById("btn-copy"),btnPin:document.getElementById("btn-pin"),btnStats:document.getElementById("btn-stats"),filterInput:document.getElementById("filter-input"),requestTypeFilter:document.getElementById("request-type-filter"),messageFilterContainer:document.getElementById("message-filter-container"),filterConditions:document.getElementById("filter-conditions"),filterStats:document.getElementById("filter-stats"),btnAddFilter:document.getElementById("btn-add-filter"),btnApplyFilters:document.getElementById("btn-apply-filters"),btnClearFilters:document.getElementById("btn-clear-filters"),btnToggleFilter:document.getElementById("btn-toggle-filter"),btnScrollTop:document.getElementById("btn-scroll-top"),btnAutoScroll:document.getElementById("btn-auto-scroll"),btnSavePreset:document.getElementById("btn-save-preset"),btnLoadPreset:document.getElementById("btn-load-preset"),messageSearchInput:document.getElementById("message-search-input"),btnClearSearch:document.getElementById("btn-clear-search"),exportDropdown:document.querySelector(".export-dropdown"),btnExport:document.getElementById("btn-export"),exportMenu:document.getElementById("export-menu"),presetModal:document.getElementById("preset-modal"),presetModalTitle:document.getElementById("preset-modal-title"),presetModalBody:document.getElementById("preset-modal-body"),presetModalFooter:document.getElementById("preset-modal-footer"),presetModalClose:document.getElementById("preset-modal-close"),statsModal:document.getElementById("stats-modal"),statsModalBody:document.getElementById("stats-modal-body"),statsModalClose:document.getElementById("stats-modal-close"),btnSaveConnection:document.getElementById("btn-save-connection"),btnSavedConnections:document.getElementById("btn-saved-connections"),savedConnectionsModal:document.getElementById("saved-connections-modal"),savedConnectionsModalTitle:document.getElementById("saved-connections-modal-title"),savedConnectionsModalBody:document.getElementById("saved-connections-modal-body"),savedConnectionsList:document.getElementById("saved-connections-list"),savedConnectionsModalClose:document.getElementById("saved-connections-modal-close"),btnCloseSavedModal:document.getElementById("btn-close-saved-modal"),btnDeleteAllSaved:document.getElementById("btn-delete-all-saved")},Le=chrome.runtime.connect({name:"stream-panel"});function Ee(){var t;v=he,T(he),function(e){E=e}(he),function(e){j=e}(he),function(e){z=e}(he),function(e){K=e}(he),function(e){ie=e}(he),ae(he,Le),function(){const e=document.getElementById("message-table");if(!e)return;const t=e.querySelectorAll(".col-resizer");let n=null,s=0,o=0,a=null,i="";function r(t){if(!n||!a||!i)return;const r=t.pageX-s,l=Math.max(40,o+r);e.style.setProperty("--col-"+i+"-width",l+"px"),"data"===i&&e.querySelectorAll(".col-data").forEach(e=>{e.style.flex="none"})}function l(){n&&n.classList.remove("resizing"),n=null,a=null,i="",document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",l)}t.forEach(e=>{e.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation(),n=e,a=e.parentElement,i=e.dataset.col,s=t.pageX,o=a.offsetWidth,e.classList.add("resizing"),document.body.style.cursor="col-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",r),document.addEventListener("mouseup",l)})})}(),t={renderMessageList:F,showListView:C,renderFilterConditions:_},f={...f,...t},function(e){S={...S,...e}}({filterMessages:H,searchMessages:ve}),function(e){oe={...oe,...e}}({renderConnectionList:y,renderMessageList:F,showMessageDetail:k,toggleFilterContainer:R,handleExport:be,showSavePresetModal:W,showLoadPresetModal:Y,closePresetModal:Z,showStatisticsModal:ee,closeStatisticsModal:te,showSaveConnectionModal:le,showSavedConnectionsModal:de,closeSavedConnectionsModal:me,deleteAllSavedConnections:ue,updatePinButtonState:A}),function(e){O={...O,...e}}({renderMessageList:F,updateFilterStats:P}),function(e){Q={...Q,...e}}({renderMessageList:F,renderFilterConditions:_}),function(e){re={...re,...e}}({renderConnectionList:y,renderMessageList:F,selectConnection:b}),document.addEventListener("addFilter",()=>{!function(){const t=q();0!==t.length?(e.pendingFilters.push({field:t[0]||"",mode:"equals",value:""}),j.messageFilterContainer.style.display="block",j.btnToggleFilter.classList.add("expanded"),_()):alert("å½“å‰æ²¡æœ‰å¯ç”¨çš„å­—æ®µï¼Œè¯·å…ˆé€‰æ‹©è¿æ¥å¹¶ç­‰å¾…æ¶ˆæ¯æ•°æ®ã€‚")}()}),document.addEventListener("applyFilters",()=>{U()}),document.addEventListener("clearFilters",()=>{e.pendingFilters=[],e.messageFilters=[],j.messageFilterContainer.style.display="none",j.btnToggleFilter.classList.remove("expanded"),_(),O.renderMessageList&&O.renderMessageList()})}Le.postMessage({type:"init",tabId:chrome.devtools.inspectedWindow.tabId}),Le.onMessage.addListener(function(t){switch(s("Received message:",t.type,t),t.type){case"init-data":e.connections=t.data.connections||{},s("Initialized with",Object.keys(e.connections).length,"connections"),y();break;case"stream-event":h(t.payload);break;case"navigation":e.connections={},e.selectedConnectionId=null,e.selectedMessageId=null,y(),F(),C()}}),window.__StreamPanel__={renderConnectionList:y,renderMessageList:F,showMessageDetail:k,showListView:C,showDetailView:M,renderFilterConditions:_,closePresetModal:Z,closeStatisticsModal:te},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Ee):Ee(),s("Stream Panel initialized with modular architecture")}();
